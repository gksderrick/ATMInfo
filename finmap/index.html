<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <!-- 
    장소ID 기반. 키워드 검색 / 카테고리 검색으로 획득 가능
    https://map.kakao.com/link/map/18577297
    검색
    https://map.kakao.com/link/search/카카오

  -->
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=79041506a32c6f35e2df475971e97fac&libraries=services,clusterer"></script>
</head>
<body style="margin:0;">
  <div id="map" style="width:100vw;height:100vh;margin:0;padding:0;">

  </div>
  <script>
    // https://apis.map.kakao.com/web/documentation/#Library


    var container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스
    var options = { //지도를 생성할 때 필요한 기본 옵션
      center: new kakao.maps.LatLng(37.5607318, 126.9678439), //필수!! 지도의 중심좌표.
      level: 3 //지도의 레벨(확대, 축소 정도)
    };

    var map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴


    // 컨트롤 추가
    var control = new kakao.maps.ZoomControl();
    map.addControl(control, kakao.maps.ControlPosition.TOPRIGHT); 


    
    var clusterer;

    const searchResult = [];
    const categorySearchResultLocation = [];
    var categorySearchCallback = function(result, status) {
      let newMarker;
      let infoWindow = [];

      searchResult.push(...result);
      console.log("category search results");
      console.log(searchResult);

      if (status === kakao.maps.services.Status.OK) {
        searchResult.forEach((element, index) => {
          newMarker = new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(Number(element.y), Number(element.x))
          })

          categorySearchResultLocation.push(newMarker);

          infoWindow.push(new kakao.maps.InfoWindow({
            content: `infoWindow #${index}`
          }));

          // kakao.maps.event.addListener(newMarker, 'mouseover', function(){
          //   infoWindow.open(map, newMarker);
          // });
          // kakao.maps.event.addListener(newMarker, 'mouseout', function(){
          //   infoWindow.close();
          // });
          kakao.maps.event.addListener(categorySearchResultLocation[index], 'click', function(){
            for(let i=0; i<categorySearchResultLocation.length; i++){
              if(i !== index) infoWindow[i].close();
              else{
                infoWindow[index].open(map, categorySearchResultLocation[index]);
                map.panTo(new kakao.maps.LatLng(
                  categorySearchResultLocation[index].getPosition().getLat(),
                  categorySearchResultLocation[index].getPosition().getLng()
                ));
              }
            }
            
          });
          kakao.maps.event.addListener(map, 'click', function(){
            infoWindow[index].close();
          });


          // console.log(newMarker);
        })

        // console.log("new marker list");
        console.log(categorySearchResultLocation);
      }
      

      // console.log("before custerer");
      // 마커 클러스터러
      clusterer = CreateMarkClusterer(categorySearchResultLocation);
      // console.log(clusterer);
      // console.log("after custerer");
    };

    function CreateMarkClusterer(markerList){
      return new kakao.maps.MarkerClusterer({
        map: map,
        markers: markerList,
        gridSize: 35,
        averageCenter: true,
        minLevel: 6,
        disableClickZoom: false
      });
    }


    // 검색 서비스
    var places = new kakao.maps.services.Places();

    // // 키워드 검색 기능
    // places.keywordSearch('ATM', callback);

    // 카테고리 검색 기능 (영역 지정 필수)
    places.categorySearch('BK9', categorySearchCallback, {
      location: new kakao.maps.LatLng(37.5606421, 126.9678918),
      useMapCenter: false,
      useMapBounds: false
    });


    // // 주소 좌표 변환 서비스
    // var geocoder = new kakao.maps.services.Geocoder();

    // // 주소 -> 좌표 기능
    // geocoder.addressSearch('해남군 송지면', callback);


  </script>
</body>
</html>